{% extends "base.html" %}
{% block extra_head %}
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
{% endblock %}

{% load mathfilters %}

{% block content %}
    {% load static %}
    <main id="main">
        <section id="portfolio" class="section-bg">
            <div class="container">

                <header class="section-header">
                    <h3 class="section-title">{{ univ }}에서 올라온 포스팅이에요</h3>

                </header>
                <a href="{% url 'core:match_new' %}">새로운 포스팅</a>
                <div class="row">
                    <div class="col-lg-12">
                        <ul id="portfolio-flters">
                            <li class="filter-active" id="filter_all">All
                            </li>

                            {% for category in categories %}
                                <li data-filter=".filter-{{ category }}" id="filter_{{ category }}">{{ category }}</li>
                            {% endfor %}

                        </ul>
                    </div>


                </div>


                <div class="row portfolio-container" id="CAT">
                    {% for category in categories %}
                        <div class="col-lg-4 col-md-6 portfolio-item filter-{{ category }}" onclick="say_hello()">
                            <div class="col-lg-12">
                                <ul id="portfolio-flters">
                                    <li data-filter="*" class="filter-active">All</li>

                                    {% for tag in rm_dup_tags %}
                                        <div style="display: inline-block">
                                            <li data-filter=".filter-{{ category }}-{{ tag }}"
                                                id="{{ tag }}">{{ category }}-{{ tag }}</li>
                                        </div>
                                    {% endfor %}

                                </ul>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <script>
                    {#$("#CAT").hide()#}
                    function say_hello(){
                        console.log("hi hello")
                    }
                </script>


                <div class="row portfolio-container">
                    {% for category in categories %}
                        <div class="portfolio-item filter-{{ category }}" id="search_box_{{ category }}" style="">
                            <div style="border: 1px solid black">
                                <div id="wrapper" class="wrapper">
                                    <input type="text" id="search" name="search" value='{{ category }}'
                                           autocomplete="off">
                                </div>
                                <div class="list-group" id="result" style="border:1px solid black"></div>

                                <button type="button" id="search_button" onclick="search_tag()" style="color: white;">
                                    태그 검색
                                </button>
                            </div>

                            <button type="button" onclick="document.getElementById('searchField').click()"
                                    style="color: white"></button>

                        </div>
                    {% endfor %}
                    <script>
                        var list_object = $("#filter_all")

                        {% for category in categories %}
                            document.getElementById("search_box_{{ category }}").style.display = 'none'
                        {% endfor %}

                        function hide_search_bar() {
                            {% for category in categories %}
                                document.getElementById("search_box_{{ category }}").style.display = 'none'
                            {% endfor %}
                        }
                    </script>
                    <script>
                        {#$('#search_button').hide()#}

                        function search_tag() {
                            var searchField = $('#search').val();
                            document.getElementById(searchField).click()
                        }

                        function complete(kwd) {
                            $('#search').val(kwd);
                        }

                        function delay(callback, ms) {
                            var timer = 0;
                            return function () {
                                var context = this, args = arguments;
                                clearTimeout(timer);
                                timer = setTimeout(function () {
                                    callback.apply(context, args);
                                }, ms || 0);
                            };
                        }

                        $(document).ready(function () {
                            $('html').click(function (e) {
                                if (!$(e.target).hasClass("list_group_item") && (!$(e.target).hasClass("tag_list_item"))) {
                                    $('#result').html('');
                                    $('#search_button').hide();
                                } else if ($(e.target).hasClass("tag_list_item")) {
                                    $('#result').html('');
                                    $('#search_button').show();
                                } else {
                                    $('#search_button').show()
                                }
                            })
                            $('#search').keyup(delay(function () {
                                $('#result').html('');
                                var searchField = $('#search').val();
                                $.ajax({
                                    type: "POST",
                                    url: "{% url 'core:search_store' %}",
                                    data: {'kwd': searchField, 'csrfmiddlewaretoken': '{{ csrf_token }}'},
                                    dataType: "json",
                                    async: true,
                                    success: function (response) {
                                        $.each(response, function (key, value) {
                                            if (!value.length) {
                                                $('#result').append('<div class="list_group_item">태그 검색 결과가 없습니다.</div>');
                                            } else {
                                                for (var i in value) {
                                                    $('#result').append('<div class="list_group_item">' +
                                                        '<button class="tag_list_item"onclick="javascript:complete(\'' + value[i] + '\'' + ')" style = "color:white">' +
                                                        value[i] + '</button></div>');
                                                }
                                            }
                                        });
                                    }
                                })
                            }, 300));
                        })


                    </script>
                </div>

                <script>
                    function addMinutes(date, minutes) {
                        return new Date(date.getTime() + minutes * 60000);
                    }


                </script>

                <div class="row portfolio-container">
                    {% for key, values in tag_dic.items %}
                        <div class="col-lg-4 col-md-6 portfolio-item filter-{{ key.store_id.cat_name }} {% for value in values %}filter-{{ key.store_id.cat_name }}-{{ value.content }} {% endfor %}">
                            <div class="portfolio-wrap">
                                <img src="{{ key.store_id.logo }}" class="img-fluid" alt="" style="width: 100%;">
                                <div class="portfolio-info" style="height:200px;">
                                    <h4><a href="#">{{ key.user_id }}</a></h4>
                                    <p>{{ key.store_id }}</p>

                                    {% for value in values %}
                                        <p>{{ value.content }}</p>
                                    {% endfor %}
                                    <div>
                                        <a href="{{ key.store_id.logo }}"
                                           data-lightbox="portfolio"
                                           data-title="App 1" class="link-preview" title="Preview"><i
                                                class="ion ion-eye"></i></a>
                                        <a href="#" class="link-details" title="More Details"><i
                                                class="ion ion-android-open"></i></a>
                                        <div id="clock_{{ key.pk }}" style="color: white"></div>
                                    </div>
                                </div>
                            </div>
                            <div style="color: white;">
                                <p>카테고리: {{ key.store_id.cat_name }}</p>
                                <p>포스팅 id: {{ key }}</p>
                                <p>유저 id: {{ key.user_id }}</p>
                                <p>포스팅 타이머: {{ key.timer }}</p>
                                <p>포스팅 게시 날짜: {{ key.create_date }}</p>
                                <p>태그: {% for value in values %}#{{ value.content }} {% endfor %}</p>
                                <p>유저 good review: {{ key.user_id.profile.good_review }}</p>
                                <p>유저 bad review: {{ key.user_id.profile.bad_review }}</p>
                                <p>메뉴 : {{ key.menu }}</p>
                                {% with answer=key.user_id.profile.good_review|add:key.user_id.profile.bad_review %}
                                    <p>만족도: {{ key.user_id.profile.good_review|div:answer }}</p>
                                {% endwith %}
                                <p>최소 배달 금액: {{ key.store_id.min_price }}</p>
                            </div>
                        </div>

                        <script>

                            // Set the date we're counting down to
                            // Update the count down every 1 second
                            var x = setInterval(function () {
                                var now = new Date().getTime();
                                var create_date_{{ key.pk }} = '{{ key.create_date_string }}'
                                var create_date_{{ key.pk }}_js = new Date(create_date_{{ key.pk }});
                                var due_date_{{ key.pk }} = addMinutes(create_date_{{ key.pk }}_js, {{ key.timer }})
                                // Get today's date and time
                                // Find the distance between now and the count down date
                                var distance = due_date_{{ key.pk }} - now;
                                // Time calculations for days, hours, minutes and seconds
                                var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                                var seconds = Math.floor((distance % (1000 * 60)) / 1000);


                                // Output the result in an element with id="demo"
                                document.getElementById("clock_{{ key.pk }}").innerHTML = "<p>" + hours + "h "
                                    + minutes + "m " + seconds + "s" + "</p>";

                                // If the count down is over, write some text
                                if (distance < 0) {
                                    clearInterval(x);
                                    document.getElementById("clock_{{ key.pk }}").innerHTML = "<p>expired</p>";
                                }
                            }, 1000);

                        </script>

                    {% endfor %}
                </div>
            </div>


        </section><!-- #portfolio -->
    </main>

{% endblock %}


